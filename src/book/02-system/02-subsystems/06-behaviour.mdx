---
section: System
chapter: Subsystems
title: Behaviour
description: Behaviour and how it works in the NUbots codebase.
slug: /system/subsystems/behaviour
---

The behaviour subsystem includes walk planning, soccer strategies, get up detection, head behaviour, script running and tuning, and kick behaviour.

## Walk Behaviour

The [Direct Walk Controller](https://github.com/NUbots/NUbots/tree/main/module/behaviour/skills/DirectWalkController) sends messages to the walk engine. It can send a message to enable or disable the walk engine, stop the walk engine, or send a `WalkCommand` message to the walk engine.

### Keyboard Walk

The [keyboardwalk module](https://github.com/NUbots/NUbots/tree/main/module/behaviour/strategy/KeyboardWalk) is used for **testing** and **demonstration** purposes. Keyboard walk can use any of the walk engines in the codebase, and acts as an interface for any one of them.

Keyboard walk uses **keyboard inputs** to control the robot. The inputs available are detailed in the following table.

| Command      | Description                                                                      |
| ------------ | -------------------------------------------------------------------------------- |
| <kbd>e</kbd> | Toggles the walk on and off. Initially it is off.                                |
| <kbd>w</kbd> | Adds 0.01 to the walk command x-value. This value is in meters/second.           |
| <kbd>s</kbd> | Adds -0.01 to the walk command x-value. This value is in meters/second.          |
| <kbd>a</kbd> | Adds 0.01 to the walk command y-value. This value is in meters/second.           |
| <kbd>d</kbd> | Adds -0.01 to the walk command y-value. This value is in meters/second.          |
| <kbd>z</kbd> | Adds 0.1 to the walk command rotational value. This value is in radians/second.  |
| <kbd>x</kbd> | Adds -0.1 to the walk command rotational value. This value is in radians/second. |
| <kbd>,</kbd> | Runs the kick with the left foot.                                                |
| <kbd>.</kbd> | Runs the kick with the right foot.                                               |
| <kbd>g</kbd> | Runs the get up.                                                                 |
| <kbd>←</kbd> | Head turns to the left.                                                          |
| <kbd>→</kbd> | Head turns to the right.                                                         |
| <kbd>↑</kbd> | Head turns upwards.                                                              |
| <kbd>↓</kbd> | Head turns downwards.                                                            |
| <kbd>r</kbd> | Resets keyboardwalk. Head rotation is set to 0. Walk command is set to 0.        |
| <kbd>q</kbd> | Quits keyboardwalk.                                                              |

To use KeyboardWalk, build the [keyboardwalk role](https://github.com/NUbots/NUbots/blob/main/roles/keyboardwalk.role) and run the binary.

The [**keyboardwalkfake** role](https://github.com/NUbots/NUbots/blob/main/roles/keyboardwalkfake.role) uses HardwareSimulator, and is useful for when you don't want to run keyboard walk on the robot.

### PS3 Walk

The [PS3 walk module](https://github.com/NUbots/NUbots/tree/main/module/behaviour/strategy/PS3Walk) is an interface for **testing** and **demonstrating** the walk and other functionalities using a **PS3 controller**.

The module connects to the PS3 controller using bluetooth (or USB) and reacts based on joystick or button input.

| Command                   | Description                                |
| ------------------------- | ------------------------------------------ |
| Left Joystick Horizontal  | Adds rotational speed to the walk command. |
| Left Joystick Vertical    | Adds x speed to the walk command.          |
| Right Joystick Horizontal | Changes the head yaw.                      |
| Right Joystick Vertical   | Changes the head pitch.                    |
| TRIANGLE                  | Toggles walking on/off.                    |
| SQUARE                    | Toggles locking of the head.               |
| R2                        | Right kick.                                |

To use this module, build the [PS3Walk role](https://github.com/NUbots/NUbots/blob/main/roles/ps3walk.role) and install it on the robot. Ensure the PS3 controller is paired and connected to the right robot. Then run the `./ps3walk` on the robot to begin controlling it.

#### Setup

1. Install `bluez`, `bluez-utils`, and `bluez-plugins` if they have not already been installed:
   ```
   pacman -S --needed bluez bluez-utils bluez-plugins
   ```
2. Restart the system:
   ```
   reboot now
   ```
   This is only necessary if the packages were not previously installed.
3. Start the bluetooth service:
   ```
   systemctl start bluetooth.service
   ```

<details>
<summary> Start bluetooth automatically </summary>

Bluetooth can be powered on automatically when the system starts. This enables the controllers to
connect without having to run `systemctl start bluetooth.service` and `bluetoothctl power on`. This
is not enable by default because we're currently unsure whether wifi and bluetooth are interferring
with each other.

1. Run
   ```
   systemctl enable bluetooth.service
   ```
2. Set `AutoEnable=true` in `/etc/bluetooth/main.conf`:
   ```
   [Policy]
   AutoEnable=true
   ```

Now, after restarting the robot, and having previously paired the PS3 controller, the PS3 controller
will connect to the robot automatically.

<Alert type='info'>
<code>ps3walk</code> still needs to be started in order to control the robot.
</Alert>

</details>

#### Pairing the PS3 Controller via Bluetooth

1. Unplug and power off the PS3 controller.
2. The interactive program `bluetoothctl`, and type the following commands:
   ```
   power on
   scan on
   discoverable on
   ```
   If bluetooth is working correrctly, you might see other devices appear and disappear.
3. Turn on the PS3 controller by pressing the middle PS button. The four LEDS should start flashing quickly.
4. Plug the PS3 controller into the computer.
5. Type `yes` when the following prompt appears:
   ```
   Authorize service 00001124-0000-1000-8000-00805f9b34fb (yes/no)
   ```

The PS3 controller is now paired. You can unplug it and it will remain connected.

<Alert type='warning'>
The controllers are extremely finicky. Placing them on the table can trigger multiple buttons to be pressed!
</Alert>

<Alert type='info'>
The steps are based on the Arch Linux <a href="https://wiki.archlinux.org/title/Gamepad#Pairing_via_Bluetooth">guide</a>. If you are having trouble or are connecting a different controller try using their guide as a starting point.
</Alert>

#### Verifying the PS3 Controller is functioning correctly.

Verifying the PS3 controller is connected and sending messages is useful for debugging the range, interferance, event codes, and making sure the controller is connect to the right robot.

1. Install `joyutils`:
   ```
   pacman -S --needed joyutils
   ```
2. If you are connected via ssh run:
   ```
   jstest --event /dev/input/js0
   ```
   Otherwise, if you're connected to a virtual console:
   ```
   jstest /dev/input/js0
   ```
3. Move controller inputs, and press `Cntl-C` to exit.

Connecting multiple PS3 controllers is possible. The first PS3 controller that connects is located at `/dev/input/js0`. The second controller that connects is then located at `/dev/input/js1`.
Additionally, the LEDs on the controllers show which number they are. This holds true regardless of whether the controller is connected over Bluetooth or USB.

## Script Runner

[ScriptRunner](https://github.com/NUbots/NUbots/tree/96357855b059cd499021552b3e25a4b158828dc5/module/behaviour/tools/ScriptRunner) is a module in the behaviour subsystem. It takes the name of one or more script files as arguments and attempts to run the scripts. It does not take file paths, only the file name/s of the script/s to execute. Any role with the ScriptRunner module must also contain the [ScriptEngine](/system/subsystems/motion#script-engine) module.

When ScriptRunner is executed, it stores the script file names passed to it as a vector of strings. When the green button on the robot is pushed, the scripts are executed in order of appearance, one after the other. ScriptRunner also provides an option to set a delay before the execution of the first script, as well as a delay between the execution of each script.

An example of using ScriptRunner to run a script called `Stand.yaml` is:

```bash
./scriptrunner Stand.yaml
```

## Script Tuner

[ScriptTuner](https://github.com/NUbots/NUbots/tree/96357855b059cd499021552b3e25a4b158828dc5/module/behaviour/tools/ScriptTuner) is a module in the behaviour subsystem. Using a command-line argument, it can either create a new script or open an existing script for editing. It uses [curses](<https://en.wikipedia.org/wiki/Curses_(programming_library)>) to create a user interface in the terminal. Through this user interface, YAML files are created or edited that specify a script that can then be used by other modules.

A script consists of frames (also called targets) which specify the position of one or more servos at a given time. The ScriptTuner interface allows for stepping through and modifying those frames. When a frame is selected in ScriptTuner, a ServoCommand for that frame will be emitted to the robot. By stepping through multiple frames, the entire script can be played back on the robot, allowing the user to preview changes to the script.

ScriptTuner also allows for "locking" and "unlocking" servos on the robot. When a servo is "locked", its position can only be changed in ScriptTuner. When it is "unlocked", the servo can be moved physically on the robot, which will update the position value in the script. Locking a servo involves emitting a ServoCommand for the current position of the servo. Unlocking the servo involves emitting a ServoCommand with zero torque and gain.

To learn how to use ScriptTuner, read the [ScriptTuner guide](/guides/main/tuning-and-running-scripts#script-tuner).
