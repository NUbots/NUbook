---
section: System
chapter: NUbots
title: Script System
description: How the NUbots script system works.
slug: /system/nubots/script-system
---

Scripts are static motions for the robot. They specify what joint angles to move to and how long the robot should take to get to those joint positions. For example, standing up is a basic script telling the robot to move its joints to the stand position over a one second time period. There can be many of these position specifications in a row to make the robot do more complex movements like getting up or kicking.

To learn how to tune scripts, see the [ScriptTuner guide](/guides/nubots/script-tuner).

# Script Engine

## Messages

To execute a script, we emit an "execute script" message describing the script to execute. This message is received in the ScriptEngine, which executes the appropriate script. These are specified in [Script.h](https://github.com/NUbots/NUbots/blob/master/shared/extension/Script.h) as [ExecuteScriptByName](https://github.com/NUbots/NUbots/blob/96357855b059cd499021552b3e25a4b158828dc5/shared/extension/Script.h#L224) and [ExecuteScript](https://github.com/NUbots/NUbots/blob/96357855b059cd499021552b3e25a4b158828dc5/shared/extension/Script.h#L261).

`ExecuteScriptByName` takes

- a subsumption ID
- the name of the script/s as a string or a vector of strings
- the duration of the scripts
- the time that these scripts should start executing

An example of receiving this message is in [ScriptEngine.cpp](https://github.com/NUbots/NUbots/blob/96357855b059cd499021552b3e25a4b158828dc5/module/motion/ScriptEngine/src/ScriptEngine.cpp#L51).

```cpp
on<Trigger<ExecuteScriptByName>>().then([this](const ExecuteScriptByName& command) {...}
```

An example of emitting this message is in [KickScript.cpp](https://github.com/NUbots/NUbots/blob/96357855b059cd499021552b3e25a4b158828dc5/module/behaviour/skills/KickScript/src/KickScript.cpp#L102)

```cpp
emit(std::make_unique<ExecuteScriptByName>(
    id, std::vector<std::string>({"Stand.yaml", "KickRight.yaml", "Stand.yaml"})));
```

Note these are only the names of the scripts, not the full paths. The names correspond to the names of YAML files in the [scripts folder](https://github.com/NUbots/NUbots/tree/master/module/motion/ScriptEngine/data/scripts).

In addition to using the name of a script, we can also use [a instance of Script](https://github.com/NUbots/NUbots/blob/96357855b059cd499021552b3e25a4b158828dc5/shared/extension/Script.h#L43) directly. `Script` can be instantiated with all the information for the script to execute, and can be emitted using the `ExecuteScript` message. `ExecuteScript` takes:

- a subsumption ID
- a Script or vector of Scripts
- the duration of the scripts
- the time that these scripts should start executing

An example of receiving this messages is in [ScriptEngine.cpp](https://github.com/NUbots/NUbots/blob/96357855b059cd499021552b3e25a4b158828dc5/module/motion/ScriptEngine/src/ScriptEngine.cpp#L71)

```cpp
on<Trigger<ExecuteScript>>().then([this](const ExecuteScript& command) {...}
```

An example of emitting this message is in [ScriptTuner.cpp](https://github.com/NUbots/NUbots/blob/96357855b059cd499021552b3e25a4b158828dc5/module/behaviour/tools/ScriptTuner/src/ScriptTuner.cpp#L590)

```cpp
emit(std::make_unique<ExecuteScript>(id, script, NUClear::clock::now()));
```

The [ScriptEngine](https://github.com/NUbots/NUbots/tree/master/module/motion/ScriptEngine) module receives either of these messages and processes the information for the script. It collects the servo positions and time for each frame and modifies them if needed based on the given duration and start time in the message. The information is then emitted as a [ServoCommand](https://github.com/NUbots/NUbots/blob/master/shared/message/behaviour/ServoCommand.proto) message.

## Script files

The script files are YAML files specifying a duration and list of servo targets, in a format like the following:

```yaml
- duration: 1000
  targets:
    - id: HEAD_YAW
      position: 0
      gain: 30
      torque: 100
    - id: HEAD_PITCH
      position: 0.5
      gain: 30
      torque: 100
    - id: R_HIP_YAW
      position: -0.03
      gain: 30
      torque: 100
```

These script files are in the ScriptEngine module. Scripts can be specific to a robot. More on scripts can be found on the [Configuration and Script System](/system/nubots/config-script) page.

# Script Runner

[ScriptRunner](https://github.com/NUbots/NUbots/tree/master/module/behaviour/tools/ScriptRunner) is a module in the behaviour subsystem. It takes the name of one or more script files as arguments and attempts to run the scripts. It does not take file paths, only the file name/s of the script/s to execute. Any role with the ScriptRunner module must also contain the ScriptEngine module.

When ScriptRunner is ran, it stores the script file names passed to it as a vector of strings. When the middle button on the robot is pushed, the scripts are executed in order of appearance, one after the other. ScriptRunner also provides an option to set a delay before execution of the first script, as well as a delay between the execution of each script.

An example of using ScriptRunner to run a script called `Stand.yaml` is:

```bash
./scriptrunner Stand.yaml
```

# Script Tuner

[ScriptTuner](https://github.com/NUbots/NUbots/tree/master/module/behaviour/tools/ScriptTuner) is a module in the behaviour subsystem. Using a command-line argument, it can either create a new script or open an existing script for editing. It uses [curses](https://en.wikipedia.org/wiki/Curses_(programming_library) to create a user interface in the terminal. Through this user interface, YAML files are created or edited that specify a script that can then be used by other modules.

When frames are selected in the ScriptTuner interface, a ServoCommand for that frame will be emitted to the robot. By stepping through multiple frames, the entire script can be played back on the robot, allowing the user to preview changes to the script.

ScriptTuner also allows for "locking" and "unlocking" servos on the robot. When a servo is "locked", its position can only be changed in ScriptTuner. When it is "unlocked", the servo can be moved physically on the robot, which will update the position value in the script. Locking a servo involves emitting a ServoCommand for the current position of the servo. Unlocking the servo involves emitting a ServoCommand with zero torque and gain.

To learn how to use ScriptTuner, read the [ScriptTuner guide](/guides/nubots/script-tuner).

# Loading YAML Script Files

The script system follows a similar structure as the [configuration system](/system/nubots/config-system). However, default scripts are moved to a platform type folder and the merging of values is skipped as it doesn't make sense to try and merge two scripts.

In the script system, we first check for a robot-specific script. If a robot-specific script does not exist, then we check for a platform-specific script.

```text
scripts/
├── nugus/
│   └── Stand.yaml
└── nugus2/
    └── Stand.yaml
```

To reiterate how the script system loads script files

1. A check is made to see if `config/RobotName/Script.yaml` exists. If it does, it is loaded.
2. If it doesn't exist, then a check is made to see if `config/PlatformName/Script.yaml` exists. If it does, it is loaded.
